# 認証機能付きWebアプリケーション

## 1. 概要

本プロジェクトは、Next.jsを用いて構築した認証・認可機能を持つWebアプリケーションである。セキュリティを考慮したユーザー管理機能の実装を行った。
また、認証方式にはセッションベース認証を採用した。

## 2. 実装機能一覧

-   **標準機能**
    -   ユーザー登録（サインアップ）
    -   ログイン・ログアウト
-   **追加実装機能**
    -   連続ログイン失敗によるアカウントロック機能
    -   ログイン履歴の表示機能

## 3. 実装機能詳細

### 3.1. 連続ログイン失敗によるアカウントロック機能

#### 目的

ブルートフォース攻撃（総当たり攻撃）やパスワードリスト攻撃に対し、アカウントの乗っ取り耐性を向上させることを目的とする。一定回数以上連続で認証に失敗したアカウントを一時的にロックし、攻撃を無効化する。

#### 実装内容

-   **データベーススキーマの変更**
    Prismaの`User`モデルに、ログイン失敗回数を記録する`failedLoginAttempts`（INTEGER型）と、アカウントのロック状態を示す`isLocked`（BOOLEAN型）の2つのフィールドを追加した。

-   **認証ロジックの変更**
    ユーザーのログイン処理において、以下のロジックを実装した。
    1.  認証試行時、対象アカウントの`isLocked`が`true`である場合、認証処理を中断し、アカウントがロックされている旨のエラーを返却する。
    2.  認証に失敗した場合、`failedLoginAttempts`をインクリメント（+1）する。
    3.  `failedLoginAttempts`が規定の閾値（本実装では5回）に達した場合、`isLocked`を`true`に更新し、アカウントをロック状態へ遷移させる。
    4.  認証に成功した場合、`failedLoginAttempts`を`0`にリセットする。

-   **UIへのフィードバック**
    アカウントがロック状態のユーザーがログインを試みた際、フロントエンドで「アカウントがロックされています」という趣旨のエラーメッセージを表示するよう実装した。

### 3.2. ログイン履歴の表示機能

#### 目的

ユーザーが自身のログイン活動を監視可能にすることで、不正アクセスを早期に検知できるようにする。アカウントの利用状況における透明性を確保し、セキュリティ意識の向上を促す。

#### 実装内容

-   **データベーススキーマの変更**
    ログイン履歴を永続化するため、新たに`LoginHistory`モデルを作成した。本モデルは`User`モデルと1対多のリレーションを持ち、以下の情報を格納する。
    -   `userId`（外部キー）
    -   `loginAt`（ログイン日時）
    -   `ipAddress`（IPアドレス）
    -   `userAgent`（ブラウザ、OS等の情報）

-   **履歴記録ロジックの実装**
    認証に成功した際、サーバー側でリクエスト情報からIPアドレスおよびUser-Agentを取得し、ログインしたユーザーID、現在時刻と共に`LoginHistory`テーブルへ新しいレコードとして保存する処理を実装した。

-   **履歴表示画面の実装**
    ログイン済みのユーザー専用ページとして「ログイン履歴」画面を作成した。本ページは、現在認証中のユーザーに紐づくログイン履歴をデータベースから取得し、降順（新しいものが上）でテーブル形式にて表示する。

## 4. 使用技術

-   フレームワーク: Next.js
-   言語: TypeScript
-   ORM: Prisma
-   データベース: PostgreSQL
-   スタイリング: Tailwind CSS
-   セキュリティ: bcrypt (パスワードハッシュ化)
-   バリデーション: Zod